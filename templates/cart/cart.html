{% extends 'base.html' %}
{% block content %}
<title>{% block title %}{{ page_titles.cart }}{% endblock %}</title>
<style>
  body {
    background: #181f2a;
    color: #fff;
  }

  .card {
    background: #21293a;
    border-radius: 18px;
    border: none;
    box-shadow: 0 2px 8px #161b2380;
    overflow-x: auto;
  }

  .cart-table th,
  .cart-table td {
    background: #232b39 !important;
    color: #fff;
    border-color: #232b39;
    vertical-align: middle;
  }

  .cart-table img {
    width: 52px;
    border-radius: 5px;
    background: #fff;
  }

  .cart-total {
    color: #11d560;
    font-size: 1.4rem;
    font-weight: 700;
  }

  .btn-checkout {
    background: #11d560;
    border: none;
    font-weight: 600;
    border-radius: 8px;
    padding: 8px 32px;
    transition: 0.2s;
  }

  .btn-checkout:hover {
    background: #0bc04f;
  }

  .btn-checkout:disabled {
    background: #666;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .quantity-form {
    gap: 2px;
  }

  .quantity-btn {
    width: 30px;
    height: 30px;
    padding: 0;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
  }

  .quantity-input {
    width: 60px;
    background: #181f2a !important;
    color: #fff !important;
    border: 1px solid #444 !important;
    text-align: center;
    font-weight: bold;
  }

  .loading {
    opacity: 0.6;
    pointer-events: none;
  }

  .stock-warning {
    background: #ffc107;
    color: #000;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
    margin-top: 5px;
    display: inline-block;
  }

  .out-of-stock {
    background: #dc3545;
    color: #fff;
  }

  .low-stock {
    background: #fd7e14;
    color: #fff;
  }

  .row-out-of-stock {
    opacity: 0.6;
    background-color: #2a1f1f !important;
  }

  .row-out-of-stock td {
    background-color: #2a1f1f !important;
  }

  .row-low-stock {
    background-color: #2a2419 !important;
  }

  .row-low-stock td {
    background-color: #2a2419 !important;
  }

  .stock-alert {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    color: #856404;
  }

  .stock-alert h5 {
    color: #856404;
    margin-bottom: 10px;
  }

  .stock-alert ul {
    margin-bottom: 10px;
    padding-left: 20px;
  }

  .product-link {
    color: #11d560;
    text-decoration: none;
    font-weight: bold;
  }

  @media (max-width: 768px) {
    .cart-table {
      width: 100%;
      min-width: 600px;
    }

    .container {
      padding-left: 10px;
      padding-right: 10px;
    }

    .card {
      padding: 15px;
    }

    .btn-checkout {
      width: 100%;
      margin-top: 15px;
    }

    .cart-total {
      display: block;
      text-align: center;
      margin-bottom: 15px;
    }

    .text-end {
      text-align: center !important;
      display: flex;
      flex-direction: column;
    }

    .quantity-form {
      max-width: 100px !important;
    }

    .quantity-input {
      width: 45px !important;
    }

    .quantity-btn {
      width: 25px;
      height: 25px;
      font-size: 12px;
    }
  }
</style>

<div class="container my-5">
  <div class="card p-4">
    <h2 class="fw-bold mb-4" style="color:#11d560;">Savatcha</h2>

    {% if cart %}
      {% for item in cart %}
        {% if item.stock == 0 or item.stock < item.quantity %}
          <div class="stock-alert">
            <h5><i class="fas fa-exclamation-triangle"></i> Diqqat: zaxira muammosi</h5>
            <ul>
              {% for cart_item in cart %}
                {% if cart_item.stock == 0 %}
                  <li>
                    Mahsulot <a href="{% url 'asic:detail' cart_item.product.id %}" class="stock-alert a">{{ cart_item.product.name }}</a>
                    tugagan
                  </li>
                {% elif cart_item.stock < cart_item.quantity %}
                  <li>
                    Mahsulot <a href="{% url 'asic:detail' cart_item.product.id %}" class="stock-alert a">{{ cart_item.product.name }}</a>:
                    savatda {{ cart_item.quantity }} ta, mavjud {{ cart_item.stock }} ta.
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
            <p class="mb-0"><small>Iltimos, miqdorni kamaytiring yoki mahsulotni o?chiring.</small></p>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <div class="table-responsive">
      <table class="table cart-table align-middle">
        <thead>
          <tr>
            <th></th>
            <th>Mahsulot</th>
            <th>Narx</th>
            <th>Miqdor</th>
            <th>Jami</th>
            <th>Amal</th>
          </tr>
        </thead>
        <tbody id="cart-tbody">
          {% for item in cart %}
          <tr data-product-id="{{ item.variant.id }}" data-price="{{ item.price }}" data-stock="{{ item.stock }}"
              {% if item.stock == 0 %}class="row-out-of-stock"{% elif item.stock < item.quantity %}class="row-low-stock"{% endif %}>
            <td>
              {% if item.product.images %}
              <img src="{{ item.product.images.url }}" alt="{{ item.product.name }}" style="width: 50px; height: 50px; object-fit: cover;">
              {% else %}
              <div style="width: 50px; height: 50px; background-color: #eee; display: flex; align-items: center; justify-content: center; color: #333; font-size: 10px;">
                Rasm yo?q
              </div>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'asic:detail' item.product.id %}" class="product-link">{{ item.product.name }}</a>
              <div class="small text-muted">Variant: {{ item.variant.color }} / {{ item.variant.size }} ({{ item.variant.sku }})</div>
              {% if item.stock == 0 %}
                <div class="stock-warning out-of-stock">Mavjud emas</div>
              {% elif item.stock < item.quantity %}
                <div class="stock-warning low-stock">Mavjud: {{ item.stock }} ta</div>
              {% elif item.stock <= 5 %}
                <div class="stock-warning">Qoldi: {{ item.stock }} ta</div>
              {% endif %}
            </td>
            <td class="item-price">${{ item.price|floatformat:2 }}</td>
            <td>
              <form class="quantity-form d-flex align-items-center" style="max-width: 120px;">
                {% csrf_token %}
                <input type="hidden" name="variant_id" value="{{ item.variant.id }}">
                <button type="button" class="btn btn-outline-light btn-sm quantity-btn" data-action="decrease" {% if item.stock == 0 %}disabled{% endif %}>-</button>
                <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="{{ item.stock|default:99 }}" class="form-control quantity-input mx-1" {% if item.stock == 0 %}disabled{% endif %}>
                <button type="button" class="btn btn-outline-light btn-sm quantity-btn" data-action="increase" {% if item.stock == 0 or item.quantity >= item.stock %}disabled{% endif %}>+</button>
              </form>
            </td>
            <td class="fw-bold item-total">${{ item.total_price|floatformat:2 }}</td>
            <td>
              <a href="{{ item.remove_url }}" class="btn btn-danger btn-sm remove-btn">O?chirish</a>
            </td>
          </tr>
          {% empty %}
          <tr id="empty-cart-row">
            <td colspan="6" class="text-center py-4">
              <div style="color: #888;">
                <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p class="mb-0">Savatcha bo?sh</p>
                <a href="{% url 'asic:catalog' %}" class="btn btn-outline-success mt-2">Katalogga o?tish</a>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if cart %}
    <div class="text-end mt-3" id="cart-summary">
      <span class="cart-total fw-bold" id="total-price">Jami summa: ${{ cart_total|floatformat:2 }}</span>
      <a href="{% url 'asic:checkout' %}" class="d-inline-block mt-2 mt-md-0 ms-3" id="checkout-link">
        <button type="button" class="btn btn-primary btn-checkout" id="checkout-btn">Buyurtmani rasmiylash</button>
      </a>
    </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    function checkCheckoutAvailability() {
        let hasStockIssues = false;

        document.querySelectorAll('tr[data-product-id]').forEach(row => {
            const stock = parseInt(row.dataset.stock) || 0;
            const quantity = parseInt(row.querySelector('.quantity-input').value) || 0;

            if (stock === 0 || stock < quantity) {
                hasStockIssues = true;
            }
        });

        const checkoutBtn = document.getElementById('checkout-btn');
        const checkoutLink = document.getElementById('checkout-link');

        if (hasStockIssues) {
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'Zaxira yetarli emas';
            checkoutLink.style.pointerEvents = 'none';
        } else {
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = 'Buyurtmani rasmiylash';
            checkoutLink.style.pointerEvents = 'auto';
        }
    }

    function setLoading(element, isLoading) {
        if (isLoading) {
            element.classList.add('loading');
        } else {
            element.classList.remove('loading');
        }
    }

    function updateTotals() {
        let grandTotal = 0;

        document.querySelectorAll('tr[data-product-id]').forEach(row => {
            const price = parseFloat(row.dataset.price);
            const quantity = parseInt(row.querySelector('.quantity-input').value);
            const itemTotal = price * quantity;

            row.querySelector('.item-total').textContent = `$${itemTotal.toFixed(2)}`;
            grandTotal += itemTotal;
        });

        const totalElement = document.getElementById('total-price');
        if (totalElement) {
            totalElement.textContent = `Jami summa: $${grandTotal.toFixed(2)}`;
        }

        checkCheckoutAvailability();
    }

    function updateQuantity(variantId, newQuantity) {
        const row = document.querySelector(`tr[data-product-id="${variantId}"]`);
        const stock = parseInt(row.dataset.stock) || 0;

        if (newQuantity > stock) {
            newQuantity = stock;
            row.querySelector('.quantity-input').value = newQuantity;

            if (stock === 0) {
                alert('Tanlangan variant mavjud emas');
                return;
            } else {
                alert(`Mavjud: ${stock} ta`);
            }
        }

        setLoading(row, true);

        const updateUrl = "{% url 'asic:update_cart_quantity' 0 %}".replace('0', variantId);

        fetch(updateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: `quantity=${newQuantity}`
        })
        .then(response => {
            setLoading(row, false);
            if (response.ok) {
                updateTotals();
                if (newQuantity <= 0) {
                    row.remove();
                    checkEmptyCart();
                }
            } else {
                location.reload();
            }
        })
        .catch(() => {
            setLoading(row, false);
            location.reload();
        });
    }

    function checkEmptyCart() {
        const tbody = document.getElementById('cart-tbody');
        const cartSummary = document.getElementById('cart-summary');

        if (tbody.children.length === 0) {
            tbody.innerHTML = `
                <tr id="empty-cart-row">
                    <td colspan="6" class="text-center py-4">
                        <div style="color: #888;">
                            <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p class="mb-0">Savatcha bo?sh</p>
                            <a href="{% url 'asic:catalog' %}" class="btn btn-outline-success mt-2">Katalogga o?tish</a>
                        </div>
                    </td>
                </tr>
            `;

            if (cartSummary) {
                cartSummary.style.display = 'none';
            }
        }
    }

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('quantity-btn')) {
            e.preventDefault();

            const form = e.target.closest('.quantity-form');
            const input = form.querySelector('.quantity-input');
            const variantId = form.querySelector('input[name="variant_id"]').value;
            const row = form.closest('tr');
            const stock = parseInt(row.dataset.stock) || 0;

            let currentValue = parseInt(input.value) || 1;

            if (e.target.getAttribute('data-action') === 'increase') {
                if (currentValue < stock) {
                    currentValue++;
                } else {
                    alert(`Mavjud: ${stock} ta`);
                    return;
                }
            } else {
                if (currentValue > 1) {
                    currentValue--;
                }
            }

            input.value = currentValue;
            updateQuantity(variantId, currentValue);
        }
    });

    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('quantity-input')) {
            const form = e.target.closest('.quantity-form');
            const variantId = form.querySelector('input[name="variant_id"]').value;
            const row = form.closest('tr');
            const stock = parseInt(row.dataset.stock) || 0;
            let newQuantity = parseInt(e.target.value) || 1;

            if (newQuantity < 1) {
                newQuantity = 1;
            } else if (newQuantity > stock) {
                newQuantity = stock;
                alert(`Mavjud: ${stock} ta`);
            }

            e.target.value = newQuantity;
            updateQuantity(variantId, newQuantity);
        }
    });

    updateTotals();
    checkCheckoutAvailability();
});
</script>
{% endblock %}
