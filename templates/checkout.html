{% extends 'base.html' %}
{% load static %}
{% load form_helpers %}
<title>{% block title %}{{ page_titles.checkout }}{% endblock %}</title>

{% block content %}
<style>
  body {
    background: #181f2a;
    color: #fff;
  }

  .card {
    background: #21293a;
    border-radius: 18px;
    border: none;
    box-shadow: 0 2px 8px #161b2380;
  }

  .form-label,
  .form-control {
    color: #fff;
    background: #232b39;
    border: 1px solid #232b39;
    border-radius: 8px;
  }

  .form-control {
    color: #fff;
    background: #232b39;
    border: 1.5px solid #516070;
    border-radius: 8px;
  }

  .form-control:focus {
    background: #232b39;
    color: #fff;
    border-color: #11d560;
    box-shadow: 0 0 0 2px #11d56040;
  }

  .form-label {
    margin-bottom: 4px;
    font-size: 15px;
    font-weight: 500;
  }

  .btn-checkout {
    background: #11d560;
    border: none;
    font-weight: 600;
    border-radius: 8px;
    padding: 8px 24px;
    transition: 0.2s;
  }

  .btn-checkout:hover {
    background: #0bc04f;
  }

  .btn-checkout:disabled {
    background: #666;
    cursor: not-allowed;
    opacity: 0.6;
  }

  .order-summary {
    background: #232b39;
    border-radius: 10px;
    padding: 24px;
    margin-top: 0;
    color: #fff;
    font-size: 15px;
  }

  .order-summary img {
    width: 44px;
    border-radius: 5px;
    background: #fff;
    margin-right: 8px;
  }

  .order-summary h6,
  .order-summary h5 {
    color: #11d560;
    font-weight: 600;
  }

  .order-summary .text-success {
    color: #11d560 !important;
  }

  .cart-item {
    padding: 15px;
    border-radius: 12px;
    background-color: #181f2a;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease-in-out;
    margin-bottom: 15px;
    line-height: 1.4;
  }

  .cart-item img {
    width: 90px;
    height: auto;
    object-fit: cover;
    border-radius: 8px;
  }

  .cart-item-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 8px;
  }

  .cart-item-price {
    font-size: 1rem;
    font-weight: 500;
    color: #11d560;
    margin-bottom: 6px;
  }

  .cart-item-delivery {
    font-size: 0.9rem;
    color: #aaa;
    margin-bottom: 0;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    color: white;
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  @media(max-width: 768px) {
    .card { padding: 1rem !important; }
    .order-summary { padding: 14px; }
    .cart-item { flex-direction: column; align-items: flex-start; }
    .cart-item img { margin-bottom: 10px; }
  }
</style>

<div class="container my-5">
  <div class="card p-4">
    <h2 class="fw-bold mb-4" style="color:#11d560;">Buyurtmani rasmiylash</h2>

    <div class="row g-4">
      <div class="col-md-6">
<form action="{% url 'asic:checkout' %}" id="checkoutForm" method="post">
  {% csrf_token %}

  <div class="form-group">
    <label for="username">Login</label>
    <input type="text" id="username" name="username" class="form-control" value="{{ request.user.username }}">
  </div>

  <div class="form-group">
    <label for="last_name">Familiya</label>
    <input type="text" id="last_name" name="last_name" class="form-control" value="{{ request.user.profile.last_name }}">
  </div>

    {% if applied_cart_discounts %}
    {% for discount in applied_cart_discounts %}
      <input type="hidden" name="discount_percentage" value="{{ discount.discount_percent|floatformat:2 }}">
    {% endfor %}
  {% endif %}
  <div class="form-group">
    <label for="first_name">Ism</label>
    <input type="text" id="first_name" name="first_name" class="form-control" value="{{ request.user.profile.first_name }}">
  </div>

  <div class="form-group">
    <label for="middle_name">Sharif</label>
    <input type="text" id="middle_name" name="middle_name" class="form-control" value="{{ request.user.profile.father_name }}">
  </div>

  <div class="form-group">
    <label for="email">Email</label>
    <input type="email" id="email" name="email" class="form-control" value="{{ request.user.email }}">
  </div>

  <div class="form-group">
    <label for="phone">Telefon</label>
    <input type="tel" id="phone" name="phone" class="form-control" value="{{ request.user.profile.phone }}">
  </div>

  <div class="form-group">
    <label for="country">Mamlakat*</label>
    <input type="text" id="country" name="country" class="form-control" value="{{ request.user.profile.country }}" required>
  </div>

  <div class="form-group">
    <label for="address_region">Viloyat</label>
    <input type="text" id="address_region" name="address_region" class="form-control" value="{{ request.user.profile.address_region }}">
  </div>

  <div class="form-group">
    <label for="address_city">Shahar</label>
    <input type="text" id="address_city" name="address_city" class="form-control" value="{{ request.user.profile.address_city }}">
  </div>

  <div class="form-group">
    <label for="address_street">Ko'cha</label>
    <input type="text" id="address_street" name="address_street" class="form-control" value="{{ request.user.profile.address_street }}">
  </div>

  <div class="form-group">
    <label for="house">Uy*</label>
    <input type="text" id="house" name="house" class="form-control" value="{{ request.user.profile.home }}" required>
  </div>

  <div class="form-group">
    <label for="block">Korpus</label>
    <input type="text" id="block" name="block" class="form-control">
  </div>

  <div class="form-group">
    <label for="apartment">Xonadon</label>
    <input type="text" id="apartment" name="apartment" class="form-control">
  </div>

  <div class="form-group">
    <label for="address_postal_code">Pochta indeksi</label>
    <input type="text" id="address_postal_code" name="address_postal_code" class="form-control" value="{{ request.user.profile.address_postal_code }}">
  </div>

  <div class="form-group">
    <label for="deliveryType">Yetkazib berish turi*</label>
    <select name="delivery_type" id="deliveryType" class="form-control" required>
      {% for code, name in delivery_types %}
      <option value="{{ code }}" data-rate="{{ code|get_delivery_rate:delivery_settings }}">{{ name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label for="documentType">Hujjat turi*</label>
    <select name="document_type" id="documentType" class="form-control" required>
      {% for code, name in document_types %}
      <option value="{{ code }}" data-percentage="{{ code|get_document_percentage:delivery_settings }}">{{ name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="form-group">
    <label for="notes">Izoh</label>
    <textarea name="notes" id="notes" class="form-control" rows="3"></textarea>
  </div>

<button type="submit" class="btn btn-checkout btn-lg w-100 mt-2">Tasdiqlash</button>
</form>
      </div>

      <div class="col-md-6">
        <div class="order-summary">
          <h5>Yetkazib berish haqida</h5>
          <p>{{ site_settings.checkout_text|linebreaksbr }}</p>
          <hr>

          <h6>Buyurtma tarkibi:</h6>

          <ul class="list-unstyled mb-3" id="cart-items-list">
            {% for item in cart %}
            <li class="cart-item d-flex align-items-center" data-quantity="{{ item.quantity }}" data-original-price="{{ item.original_price }}" data-discounted-price="{{ item.discounted_price }}">
              <img src="{{ item.product.images.url }}" alt="{{ item.product.name }}" class="me-3">
              <div>
                <div class="cart-item-name">{{ item.product.name }}</div>
                <div class="small text-muted">Variant: {{ item.variant.color }} / {{ item.variant.size }} ({{ item.variant.sku }})</div>

                {% if item.discounted_price != item.original_price %}
                <div class="text-muted" style="text-decoration: line-through;">${{ item.original_price|floatformat:2 }} {{ item.quantity }}</div>
                {% endif %}

                <div class="cart-item-price">${{ item.discounted_price|floatformat:2 }}  {{ item.quantity }} = ${{ item.item_total|floatformat:2 }}</div>

                {% if item.discounted_price != item.original_price %}
                <div class="text-success small mt-1">Tejov: ${{ item.product_discount|floatformat:2 }}</div>
                {% endif %}

                <div class="cart-item-delivery">
                  Yetkazib berish: $<span class="item-delivery-per-unit">{{ item.delivery_cost_per_unit|floatformat:2 }}</span> {{ item.quantity }} =
                  $<span class="item-delivery-total">{{ item.total_delivery_cost|floatformat:2 }}</span>
                </div>
              </div>
            </li>
            {% empty %}
            <li class="cart-empty">Savatcha bo'sh</li>
            {% endfor %}
          </ul>

          <div class="d-flex justify-content-between mt-1">
            <span>Mahsulotlar summasi:</span>
            <span>$<span id="cartSubtotal">{{ cart_subtotal|floatformat:2 }}</span></span>
          </div>

          {% if cart_discount > 0 %}
          <div class="d-flex justify-content-between text-success">
            <span>Qo'shimcha chegirma:</span>
            <span>-$<span id="cartDiscount">{{ cart_discount|floatformat:2 }}</span></span>
          </div>
          {% endif %}

          <div class="d-flex justify-content-between mt-1 fw-bold">
            <span>Chegirmadan keyin:</span>
            <span class="text-success">$<span id="discountedCartTotal">{{ discounted_cart_total|floatformat:2 }}</span></span>
          </div>

          <hr class="my-2">

          <div class="d-flex justify-content-between mt-1">
            <span>Yetkazib berish:</span>
            <span>$<span id="deliveryFee">{{ default_delivery_cost|floatformat:2 }}</span></span>
          </div>

          <div class="d-flex justify-content-between mt-1">
            <span>Hujjatlar:</span>
            <span>$<span id="documentFee">{{ default_document_cost|floatformat:2 }}</span></span>
          </div>

          <div class="d-flex justify-content-between mt-2 fs-5">
            <span>Jami:</span>
            <span class="text-success fw-bold">$<span id="grandTotal">{{ final_checkout_total|floatformat:2 }}</span></span>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deliverySelect = document.getElementById('deliveryType');
    const documentSelect = document.getElementById('documentType');
    const deliveryFeeElement = document.getElementById('deliveryFee');
    const documentFeeElement = document.getElementById('documentFee');
    const grandTotalElement = document.getElementById('grandTotal');
    const checkoutForm = document.getElementById('checkoutForm');

    const parseLocalizedFloat = (value) => {
        if (typeof value === 'string') {
            return parseFloat(value.replace(',', '.').replace(/\s/g, ''));
        }
        return parseFloat(value);
    };

    const cartSubtotal = parseLocalizedFloat('{{ cart_subtotal|default:0 }}');
    const discountedCartTotal = parseLocalizedFloat('{{ discounted_cart_total|default:0 }}');

    const cartItems = [];
    document.querySelectorAll('.cart-item[data-quantity]').forEach(item => {
        cartItems.push({
            quantity: parseInt(item.dataset.quantity),
            element: item
        });
    });

    function updateTotals() {
        const deliveryOption = deliverySelect.options[deliverySelect.selectedIndex];
        const deliveryRatePerUnit = parseFloat(deliveryOption.dataset.rate) || 0;

        const documentOption = documentSelect.options[documentSelect.selectedIndex];
        const documentPercentage = parseFloat(documentOption.dataset.percentage) || 0;

        let totalDeliveryCost = 0;

        cartItems.forEach(item => {
            const itemDeliveryCost = deliveryRatePerUnit * item.quantity;
            totalDeliveryCost += itemDeliveryCost;

            const perUnitElement = item.element.querySelector('.item-delivery-per-unit');
            const totalElement = item.element.querySelector('.item-delivery-total');

            if (perUnitElement) perUnitElement.textContent = deliveryRatePerUnit.toFixed(2);
            if (totalElement) totalElement.textContent = itemDeliveryCost.toFixed(2);
        });

        const documentCost = cartSubtotal * (documentPercentage / 100);
        const grandTotal = discountedCartTotal + totalDeliveryCost + documentCost;

        deliveryFeeElement.textContent = totalDeliveryCost.toFixed(2);
        documentFeeElement.textContent = documentCost.toFixed(2);
        grandTotalElement.textContent = grandTotal.toFixed(2);

        window.checkoutTotals = {
            deliveryFee: totalDeliveryCost,
            documentFee: documentCost,
            grandTotal: grandTotal
        };
    }

    checkoutForm.addEventListener('submit', function() {
        if (window.checkoutTotals) {
            const existingFields = checkoutForm.querySelectorAll(
                'input[name="delivery_fee"], input[name="document_fee"], input[name="grand_total"]'
            );
            existingFields.forEach(field => field.remove());

            const fields = [
                { name: 'delivery_fee', value: window.checkoutTotals.deliveryFee },
                { name: 'document_fee', value: window.checkoutTotals.documentFee },
                { name: 'grand_total', value: window.checkoutTotals.grandTotal }
            ];

            fields.forEach(field => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = field.name;
                input.value = field.value.toFixed(2);
                checkoutForm.appendChild(input);
            });
        }
    });

    deliverySelect.addEventListener('change', updateTotals);
    documentSelect.addEventListener('change', updateTotals);

    updateTotals();
});
</script>
{% endblock %}

{% endblock content %}
